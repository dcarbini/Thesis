---
title: "filtering_analysis"
output: html_document
---
# Filtering and DEGs analysis
The code is composed by 4 main parts:
1. Upload and arrange the data
2. Filtering 
3. Normalization
4. DEGs analysis


### 1. Upload and arrange the data
Set the working environment 
```{r setup, include=FALSE}

#Set the working directory and the working GSE
GSE <- 'GSE153320'
# On the server
#dir <- paste0("/data/omics/public_data/endocrine_disruptors/",GSE,"/results/")
# Locally
dir <- paste0("C:/Users/carbi/Desktop/UNIVERSITA/MAGISTRALE/BOLOGNA/Erasmus/Tampere/Thesis/results/",GSE,"/")

knitr::opts_knit$set(root.dir = dir)
```

Load the necessary libraries 
```{r message = FALSE, warning = FALSE}
#Load the libraries 
library ("dplyr")
library("ggplot2")
library("vsn")
library("DESeq2")

#locally
library("xlsx")
#on server
#install.packages("openxlsx")
#library("openxlsx")
```
*NOTE: on the server you can't use the library "xlsx" because it needs java that is not installed. You have to use an alternative, and then check how it reads the column and eventually change the columns' names.*


Upload the necessary data
```{r}
meta_data <- read.xlsx(paste0(dir, "/metadata/updated_", GSE,".xlsx"), sheetIndex = 1)
raw_matrix <- read.table(paste0(dir, "/processed_data/counts/count_matrix.tsv"), sep="\t")
```

Checks on the data
```{r}
data.frame(length(meta_data$title),length(colnames(raw_matrix)))
colnames(raw_matrix)
#head(meta_data)
#tail(meta_data)
```

Check if the raw data matrix column names and metadata GSM match
```{r}
# Can be avoided
identical(as.character(colnames(raw_matrix)), as.character(meta_data$geo_accession))
data.frame(colnames(raw_matrix), meta_data$geo_accession)
#match(colnames(raw_matrix), meta_data$geo_accession)
```

Remove the columns in the raw matrix that are in excess respect the metadata
```{r}
# Ensure the column names of raw_matrix are in meta_data$geo_accession
filtered_matrix <- raw_matrix[, colnames(raw_matrix) %in% meta_data$geo_accession]
raw_matrix <- filtered_matrix
```

Reorder the raw data to have the same order of the metadata
```{r}
raw_matrix<-raw_matrix[,match(colnames(raw_matrix), meta_data$geo_accession)]

#Checks 
data.frame(colnames(raw_matrix), meta_data$geo_accession)
identical(as.character(colnames(raw_matrix)), as.character(meta_data$geo_accession)) #TRUE
#match(colnames(raw_matrix), meta_data$geo_accession) 
```

Make a new variable
```{r}
#with "xlsx" library
meta_data$DEG_variables <- paste(meta_data$exposure, meta_data$exposure_time, meta_data$dose.amount.,meta_data$dose.unit.,  sep = "_")
#with "openxlsx" library
#meta_data$DEG_variables <- paste(meta_data$exposure, meta_data$exposure_time, meta_data$"dose(amount)",meta_data$"dose(unit)",  sep = "_")
conditions<-(meta_data$DEG_variables)
table(conditions)
```
*NOTE: In the last table is possible to see the number of replicated for each condition. It is possible that are present some condition with less than 3 replicates. It is better to retain them for the normalization, then you can remove them before or after the DEGs analysis.*



### 2. Filtering 
Define the function
```{r}
filter_low_counts <- function(counts.matrix, conditions, method = "cpm", normalized=FALSE, depth=NULL, cpm=1, p.adj = "fdr"){
  
  if(is.null(counts.matrix)){stop("Error: please provide a numeric count matrix!")}
  if(is.null(conditions)){stop("Error: please provide a factor or a vector indicating the conditions!")}
  if(!method %in% c("cpm", "wilcoxon", "proportion")) {stop("Error: Please type in one of valid methods!")}
  
  
  if (method=="cpm"){
    filtered.counts = NOISeq::filtered.data(counts.matrix, factor = conditions, norm = normalized, method = 1, cv.cutoff = 100, cpm = cpm, p.adj = p.adj)
    
  }else if(method=="wilcoxon"){
    filtered.counts = NOISeq::filtered.data(counts.matrix, factor = conditions, norm = normalized, method = 2, cv.cutoff = 100, p.adj = p.adj)
    
  }else if(method=="proportion"){
    
    if(is.null(depth)){stop("Error: indicate a numeric vector indicating per sample library depths")}
    if(!class(depth)=="numeric"){stop("Error: please provide the depth argument with a numeric vector!")}
    ### Compute library depth
    
    
    filtered.counts = NOISeq::filtered.data(counts.matrix, factor = conditions, norm = normalized, depth = depth, method = 3, cv.cutoff = 100, cpm = cpm, p.adj = p.adj)
  }
  return(filtered.counts)
}
```
*NOTE: Proportion test performs a proportion test on the counts per condition and feature (or pseudo-counts if data were normalized) where null hypothesis is that the feature relative expression (count proportion) is equal to cpm/10^6 and higher than cpm/10^6 for the alternative.*
*Those features with p-value greater than 0.05 in all the conditions are removed.*

Performing the filtering 
```{r}
filtered_data <- filter_low_counts(counts.matrix = raw_matrix, conditions = conditions, method = "proportion", normalized = FALSE, p.adj = "fdr", depth = as.numeric(apply(raw_matrix, 2, sum)))
```

Look at the depth of sequencing for each sample
```{r}
as.numeric(apply(filtered_data, 2, sum))
```

Look at the lowest 20 if they are a lot. (If they are not a lot you can also look at all of them so that you have a better global picture)
```{r}
# Calculate column sums while keeping column names
column_sums <- apply(filtered_data, 2, sum)
# Sort the column sums in ascending order and get the lowest 20
lowest_20 <- sort(column_sums, decreasing = FALSE)[1:20]
# Print the result: column names and their values
lowest_20
```
*NOTE: If the depth are of the same order of magnitude is ok, look that the lowest one are not too low.*
*Compare also one against the others: if some are the double or the half of others it's ok, but if some are 0.1 or 100 times another maybe there were some problems in the sequencing and you have to check in the paper, in the PCA and eventually discard the lower ones.*
*You can also do a plot to see if all the samples have the same depth.*

Save the data
```{r}
write.table(filtered_data, file = paste0(dir, "/results/filtered_raw_expression_matrix_", GSE, ".txt"), sep = "\t", col.names =TRUE)
```

### 3. Normalization

Plots (PCA) before the normalization 
*NOTE: look at them is not so necessary but better to have a look.*
```{r}
exposure<-meta_data$DEG_variables

table_transpose<-as.data.frame(t(filtered_data))
df_pca <- prcomp(table_transpose, center = TRUE, scale. = TRUE)
p <- ggplot(as.data.frame(df_pca$x), aes(x=PC1, y=PC2, color=exposure))
p <- p+geom_point()+ggtitle("Before normalization_conditions")
p

#ggsave(file="GSE125762_pca_before_normalization.svg", width=10, height=8)
```

```{r}
title<-meta_data$geo_accession

table_transpose<-as.data.frame(t(filtered_data))
df_pca <- prcomp(table_transpose, center = TRUE, scale. = TRUE)
p <- ggplot(as.data.frame(df_pca$x), aes(x = PC1, y = PC2, color = title, label = title)) +
  geom_point() +  # Use geom_point() for points
  geom_text(hjust = 0, vjust = 0) +  # Add labels with geom_text()
  ggtitle("Before normalization_ Geo accession") #+
  #xlim(-75, 140)   # Setting x-axis limits
p
```

```{r}
#If necessary
title<-meta_data$exposure_time

table_transpose<-as.data.frame(t(filtered_data))
df_pca <- prcomp(table_transpose, center = TRUE, scale. = TRUE)
p <- ggplot(as.data.frame(df_pca$x), aes(x = PC1, y = PC2, color = title, label = title)) +
  geom_point() +  # Use geom_point() for points
  geom_text(hjust = 0, vjust = 0) +  # Add labels with geom_text()
  ggtitle("Before normalization")
p
```

**Compare different transformation methods for PCA**
```{r message = FALSE, warning = FALSE}
filtered_data_as_integer<-sapply(filtered_data,as.integer)
rownames(filtered_data_as_integer)<-rownames(filtered_data)

###########################

colData <- data.frame(condition=as.vector(conditions),sample=as.vector(meta_data$geo_accession))
rownames(colData) <- colnames(filtered_data_as_integer)

# Create the matrix for DESeq2
ddsMat <- DESeq2::DESeqDataSetFromMatrix(countData = filtered_data_as_integer,
                                         colData = colData,
                                         design = ~condition) 
#Normalization
vsd <- vst(ddsMat, blind = FALSE)
vsd_counts <- assay(vsd)
#Save the results
write.table(vsd_counts, file = paste0(dir, "/results/vst_expression_matrix_", GSE, "_Blind_F.txt"), quote = FALSE, sep = "\t", row.names = TRUE, col=NA)

#NO -> now we generate only the blind False
#vsd_T <- vst(ddsMat, blind = T)
#vsd_counts_T <- assay(vsd_T)
#write.table(vsd_counts_T, file = paste0(dir, "/results/vst_expression_matrix_", GSE, "_Blind_T.txt"), quote = FALSE, sep = "\t", row.names = TRUE, col=NA)

# Other type of normalizations
rld <- rlog(ddsMat, blind = FALSE)
ntd <- normTransform(ddsMat)

#vsd <- vst(dds, blind = FALSE)
#rld <- rlog(dds, blind = FALSE)
#ntd <- normTransform(dds)
```

Plots for the 3 type of normalization performed 
```{r message = FALSE, warning = FALSE,  fig.show="hold", out.width="50%"}
print("Condition plot")
print("VST normalization")
plotPCA(vsd, intgroup = "condition", ntop = 2000)
print("RLog normalization")
plotPCA(rld, intgroup = "condition", ntop = 2000)
print("normTransform normalization")
plotPCA(ntd, intgroup = "condition", ntop = 2000)

print("Sample plot")
print("VST normalization")
plotPCA(vsd, intgroup = "sample", ntop = 2000)
print("RLog normalization")
plotPCA(rld, intgroup = "sample", ntop = 2000)
print("normTransform normalization")
plotPCA(ntd, intgroup = "sample", ntop = 2000)
```

*NOTE: From that plots you can see if there are outliers or not. If there are you have to remove them from the metadata and the raw and then perform the analysis again.*
*Talking about the samples with less than 2 replicates, you can remove them now, before the DEGs analysis, or you can go on and then don't consider them after looking at the table* _conditions_ *generated before.*


### 4. DEGs analysis
```{r}
#library('BiocParallel')

#dds <- DESeq2::DESeq(ddsMat, parallel = TRUE, BPPARAM=MulticoreParam(35))
dds <- DESeq2::DESeq(ddsMat)

total_norm_counts <- DESeq2::counts(dds, normalized=TRUE)
write.table(total_norm_counts, file = paste0(dir, "/results/normalized_expression_matrix_", GSE, ".txt"), quote = FALSE, sep = "\t", row.names = TRUE, col=NA)

table(conditions)
```

If you have more than one control you have to take a decision on which one to use for the comparison. 
To decide that, you have to take into consideration that you want to remove all the noise to remain with only the differences caused by the chemical, so you have to take the most similar control to your sample (e.g. if in your sample there is the DMSO in the media, you have to take the control with the DMSO).

You can do a for loop or create a Chunk for each control. If you have different cell lines in the same study you can add it to the conditions. 
If you have a lot of chemicals and/or concentrations is better to do a for loop. On the other side if you have only few condition in one or two time points you can write them manually. 

For loop:
```{r}
# Split the string conditions in a vector of unique conditions (exclude the control)
condition_list <- setdiff(unique(unlist(strsplit(conditions, " "))), "NA_0_µM")

# For each condition
for (cond in condition_list) {
  print(paste("Processing condition:", cond))
  # DESeq2
  res1 <- DESeq2::results(dds, contrast = c("condition", cond, "NA_0_µM"), 
                          pAdjustMethod = "fdr", independentFiltering = FALSE)
  
  # Save the unfiltered file
  write.table(res1, file = paste0(dir, "/results/DEG_results_", cond, "_vs_NA_0_µM_unfiltered_", 
                                  GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
  
  # Filering using logFC and p.adj
  res1_adj <- res1[which(res1$padj <= 0.05 & abs(res1$log2FoldChange) >= 0.58), ]
  
  # Print the dimensions of the filtered table
  print(dim(res1_adj))
  
  # Save the filtered file
  write.table(res1_adj, file = paste0(dir, "/results/DEG_results_", cond, "_vs_control_7d_filtered_", 
                                      GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
}
```

```{r}
#TIME 1
res1 <- DESeq2::results(dds, contrast = c("condition", "PFOA_7d_1_mg/kg", "control_7d_NA_NA"), pAdjustMethod = "fdr", independentFiltering = FALSE)
write.table(res1, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_7d_1_mgKG_vs_control_7d_unfiltered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
res1_adj <- res1[which(res1$padj<=0.05 & abs(res1$log2FoldChange)>=0.58),]
print(dim(res1_adj))
write.table(res1_adj, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_7d_1_mgKG_vs_control_7d_filtered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)

res2 <- DESeq2::results(dds, contrast = c("condition", "PFOA_7d_5_mg/kg", "control_7d_NA_NA"), pAdjustMethod = "fdr", independentFiltering = FALSE)
write.table(res2, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_7d_5_mgKG_vs_control_7d_unfiltered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
res2_adj <- res2[which(res2$padj<=0.05 & abs(res2$log2FoldChange)>=0.58),]
print(dim(res2_adj))
write.table(res2_adj, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_7d_5_mgKG_vs_control_7d_filtered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)

res3 <- DESeq2::results(dds, contrast = c("condition", "PFOA_7d_15_mg/kg", "control_7d_NA_NA"), pAdjustMethod = "fdr", independentFiltering = FALSE)
write.table(res3, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_7d_15_mgKG_vs_control_7d_unfiltered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
res3_adj <- res3[which(res3$padj<=0.05 & abs(res3$log2FoldChange)>=0.58),]
print(dim(res3_adj))
write.table(res3_adj, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_7d_15_mgKG_vs_control_7d_filtered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
```
Here the 3 doses are compared all against the same control performed at the analyzed time. 

```{r}
#TIME 2
res1 <- DESeq2::results(dds, contrast = c("condition", "PFOA_14d_1_mg/kg", "control_14d_NA_NA"), pAdjustMethod = "fdr", independentFiltering = FALSE)
write.table(res1, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_14d_1_mgKG_vs_control_14d_unfiltered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
res1_adj <- res1[which(res1$padj<=0.05 & abs(res1$log2FoldChange)>=0.58),]
print(dim(res1_adj))
write.table(res1_adj, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_14d_1_mgKG_vs_control_14d_filtered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)

res2 <- DESeq2::results(dds, contrast = c("condition", "PFOA_14d_5_mg/kg", "control_14d_NA_NA"), pAdjustMethod = "fdr", independentFiltering = FALSE)
write.table(res2, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_14d_5_mgKG_vs_control_14d_unfiltered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
res2_adj <- res2[which(res2$padj<=0.05 & abs(res2$log2FoldChange)>=0.58),]
print(dim(res2_adj))
write.table(res2_adj, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_14d_5_mgKG_vs_control_14d_filtered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)

res3 <- DESeq2::results(dds, contrast = c("condition", "PFOA_14d_15_mg/kg", "control_14d_NA_NA"), pAdjustMethod = "fdr", independentFiltering = FALSE)
write.table(res3, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_14d_15_mgKG_vs_control_14d_unfiltered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
res3_adj <- res3[which(res3$padj<=0.05 & abs(res3$log2FoldChange)>=0.58),]
print(dim(res3_adj))
write.table(res3_adj, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_14d_15_mgKG_vs_control_14d_filtered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)

```

```{r}
#TIME 3
res1 <- DESeq2::results(dds, contrast = c("condition", "PFOA_28d_1_mg/kg", "control_28d_NA_NA"), pAdjustMethod = "fdr", independentFiltering = FALSE)
write.table(res1, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_28d_1_mgKG_vs_control_28d_unfiltered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
res1_adj <- res1[which(res1$padj<=0.05 & abs(res1$log2FoldChange)>=0.58),]
print(dim(res1_adj))
write.table(res1_adj, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_28d_1_mgKG_vs_control_28d_filtered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)

res2 <- DESeq2::results(dds, contrast = c("condition", "PFOA_28d_5_mg/kg", "control_28d_NA_NA"), pAdjustMethod = "fdr", independentFiltering = FALSE)
write.table(res2, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_28d_5_mgKG_vs_control_28d_unfiltered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
res2_adj <- res2[which(res2$padj<=0.05 & abs(res2$log2FoldChange)>=0.58),]
print(dim(res2_adj))
write.table(res2_adj, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_28d_5_mgKG_vs_control_28d_filtered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)

res3 <- DESeq2::results(dds, contrast = c("condition", "PFOA_28d_15_mg/kg", "control_28d_NA_NA"), pAdjustMethod = "fdr", independentFiltering = FALSE)
write.table(res3, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_28d_15_mgKG_vs_control_28d_unfiltered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)
res3_adj <- res3[which(res3$padj<=0.05 & abs(res3$log2FoldChange)>=0.58),]
print(dim(res3_adj))
write.table(res3_adj, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/DEG_results_PFOA_28d_15_mgKG_vs_control_28d_filtered_", GSE, ".txt"), row.names = TRUE, sep = "\t", quote = FALSE)

```

Save the final results 
```{r}
write.xlsx(meta_data, file = paste0("/data/omics/public_data/endocrine_disruptors/", GSE, "/results/updated_",GSE, "_DEG.xlsx"), sheetName = "Sheet1", row.names = FALSE)
```


*NOTE: then you can create a volcano plot to have a first interpretation of the results of the DEGs analysis.*




